@model Hirafeyat.ViewModel.CheckoutViewModel

@{
    Layout = null;
    ViewBag.orderId = ViewBag.orderId ?? 0;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hirafyat - Checkout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="img/favicon.ico" rel="icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="~/css/style.css" rel="stylesheet">
</head>
<body>

    <div class="container-fluid bg-secondary mb-2">
        <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 100px">
            <h1 class="font-weight-semi-bold text-uppercase mb-3">Checkout</h1>
        </div>
    </div>

    <div class="container-fluid pt-5">
        <form asp-action="PlaceOrder" method="post" id="payment-form">
            @Html.AntiForgeryToken()
            <div class="row px-xl-5">
                <!-- Billing Info -->
                <div class="col-lg-6">
                    <div class="mb-4">
                        <h4 class="font-weight-semi-bold mb-4">Billing Details</h4>
                        <div class="row">
                            <div class="col-md-12 form-group">
                                <label asp-for="FullName"></label>
                                <input asp-for="FullName" class="form-control" placeholder="John Doe" />
                                <span asp-validation-for="FullName" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 form-group">
                                <label asp-for="Email"></label>
                                <input asp-for="Email" class="form-control" placeholder="example@email.com" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 form-group">
                                <label asp-for="PhoneNumber"></label>
                                <input asp-for="PhoneNumber" class="form-control" placeholder="+123 456 789" />
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 form-group">
                                <label asp-for="Address"></label>
                                <input asp-for="Address" class="form-control" placeholder="123 Main Street" />
                                <span asp-validation-for="Address" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Total -->
                <div class="col-lg-3">
                    <div class="card border-secondary mb-4">
                        <div class="card-header bg-secondary border-0">
                            <h4 class="font-weight-semi-bold m-0">Order Total</h4>
                        </div>
                        <div class="card-body">
                            <h5 class="font-weight-medium mb-3">Cart</h5>
                            <ul class="list-unstyled">
                                @foreach (var item in ViewBag.CartItems as List<Hirafeyat.Models.CartItem>)
                                {
                                    <li>@item.Product.Title x @item.Quantity = @(@item.Product.Price* item.Quantity) EGP</li>
                                }
                            </ul>
                        </div>
                        <div class="card-footer border-secondary bg-transparent">
                            <div class="d-flex justify-content-between mt-2">
                                <h5 class="font-weight-bold">Total</h5>
                                <h5 class="font-weight-bold">@ViewBag.TotalPrice EGP</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Options -->
                <div class="col-lg-3">
                    <div class="card border-secondary mb-4">
                        <div class="card-header bg-secondary border-0">
                            <h4 class="font-weight-semi-bold m-0">Payment</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="paymentMethod" id="stripe" value="stripe" checked>
                                    <label class="custom-control-label" for="stripe">Credit Card (Stripe)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="paymentMethod" id="paypal" value="paypal">
                                    <label class="custom-control-label" for="paypal">PayPal</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="paymentMethod" id="cod" value="cod">
                                    <label class="custom-control-label" for="cod">Cash on Delivery</label>
                                </div>
                            </div>

                            <!-- Stripe Payment Form -->
                            <div id="stripe-payment-container" class="mt-4">
                                <div id="card-element" class="form-control" style="padding: 10px; height: 40px;"></div>
                                <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                            </div>

                            <!-- PayPal Not Available Message -->
                            <div id="paypal-not-available" class="alert alert-warning mt-4" style="display: none;">
                                <i class="fas fa-exclamation-circle"></i> PayPal payment is not available yet. Please choose another payment method.
                            </div>

                            <!-- COD Confirmation -->
                            <div id="cod-confirmation" class="alert alert-info mt-4" style="display: none;">
                                <i class="fas fa-info-circle"></i> You'll pay cash when your order is delivered.
                            </div>
                        </div>
                        <div class="card-footer border-secondary bg-transparent">
                            <button type="button" class="btn btn-lg btn-block btn-primary font-weight-bold my-3 py-3" id="placeOrderBtn">
                                Place Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="paymentIntentId" id="paymentIntentId" value="" />
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
        var stripe = Stripe('@ViewBag.StripePublishableKey');
            var elements = stripe.elements();
            var cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                    }
                }
            });
            cardElement.mount('#card-element');
            $('input[name="paymentMethod"]').change(function() {
                var method = $(this).val();
                $('#stripe-payment-container').hide();
                $('#paypal-not-available').hide();
                $('#cod-confirmation').hide();
                if (method === 'stripe') {
                    $('#stripe-payment-container').show();
                } else if (method === 'paypal') {
                    $('#paypal-not-available').show();
                } else if (method === 'cod') {
                    $('#cod-confirmation').show();
                }
            });

            $('input[name="paymentMethod"]:checked').trigger('change');

            $('#placeOrderBtn').click(async function(e) {
                e.preventDefault();
                const formData = {
                    FullName: $('#FullName').val(),
                    Email: $('#Email').val(),
                    PhoneNumber: $('#PhoneNumber').val(),
                    Address: $('#Address').val(),
                    PaymentMethod: $('input[name="paymentMethod"]:checked').val()
                };

                if (!formData.FullName || !formData.Email || !formData.PhoneNumber || !formData.Address) {
                    Swal.fire('Error', 'Please fill all required fields', 'error');
                    return;
                }

                if (formData.PaymentMethod === 'paypal') {
                    Swal.fire('Error', 'PayPal payment is not available yet. Please choose another payment method.', 'error');
                    return;
                }
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                if (formData.PaymentMethod === 'stripe') {
                    try {
      
                        const { paymentIntent, error } = await stripe.confirmCardPayment(
                            '@ViewBag.ClientSecret', {
                                payment_method: {
                                    card: cardElement,
                                    billing_details: {
                                        name: formData.FullName,
                                        email: formData.Email,
                                        phone: formData.PhoneNumber,
                                        address: {
                                            line1: formData.Address
                                        }
                                    }
                                }
                            }
                        );

                        if (error) {
                            $('#card-errors').text(error.message);
                            $(this).prop('disabled', false).text('Place Order');
                            return;
                        }

                        if (paymentIntent.status === 'succeeded') {
                            $('#paymentIntentId').val(paymentIntent.id);
                            $('#payment-form').submit();
                        }
                    } catch (err) {
                        console.error(err);
                        Swal.fire('Error', 'An error occurred during payment processing', 'error');
                        $(this).prop('disabled', false).text('Place Order');
                    }
                } else if (formData.PaymentMethod === 'cod') {
                    $('#payment-form').submit();
                }
            });
        });
    </script>
</body>
</html>